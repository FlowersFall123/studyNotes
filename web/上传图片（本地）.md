# 上传图片（本地）
## 后端 
`Controller`
```java
  @Value("${file.upload-dir}") // 从配置文件中读取上传目录路径
    private String uploadDir;

    @PostMapping("/uploadImg")
    public RestBean<String> uploadImage(@RequestParam("image") MultipartFile file) {
        try {
            // 检查文件是否为空
            if (file.isEmpty()) {
                return RestBean.failure(400, "上传的文件为空");
            }

            // 创建上传目录（如果不存在）
            File directory = new File(uploadDir);
            if (!directory.exists()) {
                if (!directory.mkdirs()) { // 创建目录
                    return RestBean.failure(500, "无法创建上传目录");
                }
            }

            // 生成唯一的文件名
            String fileName = UUID.randomUUID().toString() + "_" + file.getOriginalFilename();
            Path filePath = Paths.get(uploadDir, fileName);

            // 将文件保存到服务器
            Files.copy(file.getInputStream(), filePath);

            // 返回成功响应，包含文件的相对路径
            String fileUrl = "uploads/" + fileName; // 相对路径
            return RestBean.success("文件上传成功", fileUrl);
        } catch (IOException e) {
            e.printStackTrace();
            return RestBean.failure(500, "文件上传失败：" + e.getMessage());
        }
    }
    
```
在`application.yml`
```language
  web:
    resources:
      static-locations:
        - classpath:/static/
        - file:${file.upload-dir} # 将上传目录配置为静态资源路径

file:
  upload-dir: ./uploads # 上传目录路径
```
## 前端(服务器上与本地的路径不一样)：
```language
  const onUploadImg = async (files, callback) => {
  const res = await Promise.all(
      files.map((file) => {
        return new Promise((resolve, reject) => {
          const form = new FormData();
          form.append('image', file);
          axios.post("api/blog/uploadImg", form, {
            headers: {
              "Content-Type": "multipart/form-data",
              "Authorization": `${localStorage.getItem("authToken")}`,
            },
          })
              .then((response) => resolve(response))
              .catch((error) => reject(error));
        });
      })
  );

  // 处理后端返回的响应
  const fileUrls = res.map((item) => {
    if (item.data.success) {
      // 如果上传成功，返回完整的文件 URL
      //return `https://www.xxx.xyz/api/${item.data.data}`;
      return `http://localhost:8080/${item.data.data}`;
    } else {
      // 如果上传失败，抛出错误
      throw new Error(item.data.message);
    }
  });

  // 调用回调函数，传递文件的 URL 列表
  callback(fileUrls);
};
```
此时就会发现一个问题就是**上传图片的功能在本地可以运行，但是在服务器上却不能正确显示**-------->**解决方法**：
<img width="547" height="301" alt="image" src="https://github.com/user-attachments/assets/39a2e143-ebf9-4b97-b7c8-842841699491" />

也就是让**服务器优先匹配后端**
```language
      # 优先匹配 /api/uploads 路径
location ^~ /api/uploads {
    # 如果这些图片文件是后端提供的，请代理到后端
    #proxy_pass http://localhost:8080;
    alias /www/wwwroot/back-end/uploads;
    autoindex on;                 # 生产环境关闭目录索引
    # 如果是静态文件，也可以改为指定实际的目录，例如：
    # root /path/to/uploads;
    # 或者让后端处理它们
}

```
路径不能显示图片--可以添加一个类

```
@Configuration
    public class WebConfig implements WebMvcConfigurer {
        @Override
        public void addResourceHandlers(ResourceHandlerRegistry registry) {
            registry.addResourceHandler("/uploads/**")
                    .addResourceLocations("file:./uploads/");  // 映射到上传目录
        }
    }
```


**补充：**
使用`input`上传头像
**前端代码：**
```vue
// 头像上传处理
const onUploadImg = async (e, callback) => {
  const file = e.target.files[0]; // 获取上传的第一个文件
  if (!file) return; // 如果没有选择文件，则退出

  const form = new FormData();
  form.append('image', file);

  try {
    const response = await axios.post("api/user/uploadImg", form, {
      headers: {
        "Content-Type": "multipart/form-data",
        "Authorization": `${localStorage.getItem("authToken")}`,
      },
    });

    if (response.data.success) {
      // 上传成功后，更新头像 URL
      options.avatar = `http://localhost:8080/${response.data.data}`;
      console.log("上传成功，新的头像地址：", options.avatar);
      return `http://localhost:8080/${response.data.data}`;
    } else {
      throw new Error(response.data.message); // 如果上传失败，抛出错误
    }
  } catch (error) {
    console.error("上传失败：", error);
    callback([]); // 上传失败时传递空的 URL 列表
  }
};
```
