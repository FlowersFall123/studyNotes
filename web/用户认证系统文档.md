# **用户认证系统文档**

## 目录

1. 前端状态管理
2. 路由守卫配置
3. 后端接口实现

------

## 前端状态管理

`userStore.js` - Pinia 状态管理

```
import { defineStore } from "pinia";

/**
 * 用户认证状态存储
 * 管理应用中的用户登录状态及相关操作
 */
export const useUserStore = defineStore('user', {
  // 状态定义
  state: () => ({
    user: null, // 当前登录用户信息，null表示未登录
  }),

  // 操作方法
  actions: {
    /**
     * 用户登录
     * @param {Object} user - 用户信息对象
     */
    login(user) {
      this.user = user;
    },

    /**
     * 用户登出
     */
    logout() {
      this.user = null;
    }
  }
});
```

------

## 路由守卫配置

`router/index.js` - 全局路由守卫

```
import { useUserStore } from '@/stores/userStore';

// 公开路由配置（无需认证）
const PUBLIC_ROUTES = new Map([
  ['/auth', '认证页面'],
  ['/test', '测试页面'],
  ['/error/401', '401未授权页面'],
  ['/error/404', '404未找到页面']
]);

/**
 * 全局路由守卫
 * 实现路由级别的访问控制
 */
router.beforeEach((to, from, next) => {
  const userStore = useUserStore();

  // 处理未匹配路由
  if (to.matched.length === 0) {
    next('/error/404');
    return;
  }

  // 检查是否为公开路由
  if (!PUBLIC_ROUTES.has(to.path)) {
    handleProtectedRoute(userStore, next);
  } else {
    next(); // 公开路由直接放行
  }
});

/**
 * 处理受保护路由的访问控制
 */
function handleProtectedRoute(userStore, next) {
  if (userStore.user === null) {
    fetchUserInfo(userStore, next);
  } else {
    next(); // 已认证用户放行
  }
}

/**
 * 从后端获取用户信息
 */
function fetchUserInfo(userStore, next) {
  get('api/user/information', {}, 
    (message, data) => {
      userStore.login(data);
      next();
    },
    () => redirectToAuth(next),
    () => redirectToAuth(next)
  );
}

/**
 * 跳转到认证页面
 */
function redirectToAuth(next) {
  next('/auth');
}
```

------

## 后端接口实现

`UserController.java` - 用户信息接口

```
@GetMapping("information")
public RestBean<User> getMyInfo(HttpServletRequest request) {
    /**
     * 获取当前用户信息接口
     * 
     * 流程：
     * 1. 从请求中获取已认证的用户ID
     * 2. 查询用户完整信息
     * 3. 清除敏感字段
     * 4. 返回处理后的用户信息
     * 
     * @param request HTTP请求对象，包含JWT令牌
     * @return 标准化响应，包含用户数据
     */
    
    // 从JWT中解析出的用户ID
    Integer userId = (Integer) request.getAttribute("id");
    
    // 查询用户信息
    User user = userService.getUserById(userId);
    
    // 安全处理
    user.setPassword(null); // 移除密码等敏感信息
    
    return RestBean.success("用户信息获取成功", user);
}
```

------

## 系统流程图

```
sequenceDiagram
    participant Frontend
    participant Router
    participant Pinia
    participant Backend

    Frontend->>Router: 访问受保护路由
    Router->>Pinia: 检查用户状态
    alt 已登录
        Pinia-->>Router: 返回用户数据
        Router-->>Frontend: 允许访问
    else 未登录
        Router->>Backend: 请求用户信息
        alt 认证成功
            Backend-->>Router: 返回用户数据
            Router->>Pinia: 存储用户数据
            Router-->>Frontend: 允许访问
        else 认证失败
            Backend-->>Router: 返回错误
            Router-->>Frontend: 跳转登录页
        end
    end
```